@startuml
title Signering med NetiD-plugin
actor User
participant Browser
participant NetiD
participant BrowserCollectLoop

participant Webcert
participant TicketTracker
participant xmldsig
participant Intygstjänsten

User -> Browser: Påbörja signering
activate Browser
Browser -> Webcert: Signeringshash

Webcert -> xmldsig: Prepare
xmldsig --> Webcert: Partiell signatur
Webcert -> Webcert: Beräkna hash och skapa SignaturBiljett
Webcert -> TicketTracker: Lagra SignaturBiljett
Webcert --> Browser: SignaturBiljett med id och base64-hash
Browser -/ BrowserCollectLoop: Starta poller

activate BrowserCollectLoop
Browser -/ NetiD: Signera(<SignedInfo/>)
deactivate Browser
activate NetiD
User -/ NetiD: Matar in PIN-kod
NetiD -/ Browser: Signatur och X509
deactivate NetiD

activate Browser
Browser -> Webcert: Signatur och X509
activate Webcert
Webcert -> xmldsig: Validera signatur
xmldsig --> Webcert: Valideringsresultat
Webcert -> Webcert: Lagra signatur
Webcert -/ Intygstjänsten: RegisterCertificate
Webcert -> TicketTracker: BiljettStatus SIGNERAD
Webcert --> Browser: SignaturBiljett
deactivate Webcert
deactivate Browser


loop tills signeringsstatus SIGNERAD


BrowserCollectLoop -> Webcert: Hämta status
Webcert -> TicketTracker: Hämta status
TicketTracker --> Webcert: SignaturBiljett
Webcert --> BrowserCollectLoop: SignaturBiljett
deactivate BrowserCollectLoop

alt Om SIGNERAD

BrowserCollectLoop -/ Browser: Ladda signerat intyg
activate Browser
end alt
alt Om ERROR
BrowserCollectLoop -/ Browser: Visa felmeddelande
end alt


end loop
Browser -> User: Visar det signerade intyget
deactivate Browser
@enduml
