pipeline {

  agent {
    // this image provides everything needed to run Cypress
    docker {
      image 'cypress/base:10'
      // image 'cypress/browsers:chrome69'  // Cypress kan inte spela in videos om man använder Chrome

      // docker-slave should probably be used here since it's not a Docker Compose project
      label 'docker-slave'
    }
  }

  environment {
    HOME = "${env.WORKSPACE}"
  }

  stages {

    stage('Handle prerequisites') {
      steps {
        echo "Running build ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh 'npm --version'
        sh 'node --version'
      }
    }

    stage('Install Cypress') {
      steps {
        sh 'npm ci'
        sh 'npm run cy:verify'
      }
    }

    stage('cypress tests') {
      steps {
        sh "npm run test:e2e:electron"
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'cypress/videos/*', fingerprint: true
      junit 'test-results.xml'
    }

    failure {
      archiveArtifacts artifacts: 'cypress/screenshots/**/*.*', fingerprint: true
    }
  }
}
