pipeline {

  // Nedanstående ska ge timestamps i console output men känns inte igen av Jenkins
  //options {
  //  timestamps ()
  //}

  environment {
    HOME = "${env.WORKSPACE}" // Behövs denna?
    UNDERKATALOG_TESTRAPPORTER = "test/cypress/results/"
    TESTRAPPORTFILPATTERN = "'test-results.*.xml'"
  }

  agent {
    // this image provides everything needed to run Cypress
    docker {
      image 'cypress/base:10'
      // image 'cypress/browsers:chrome69'  // Cypress kan inte spela in videos om man nyttjar Chrome

      label 'docker-slave'
    }
  }

  stages {

    stage('Handle prerequisites') {
      steps {
        echo "Running build ${env.BUILD_ID} on ${env.JENKINS_URL}"
        sh 'npm --version'
        sh 'node --version'
      }
    }

    stage('Install Cypress') {
      steps {
        sh 'npm ci'
        sh 'npm run cy:verify'
      }
    }

    stage('Clean up old test reports') {
      steps {
        sh 'rm -fr ${env.WORKSPACE}/${UNDERKATALOG_TESTRAPPORTER}/${TESTRAPPORTFILPATTERN}'
      }
    }

    stage('cypress tests') {
      steps {
        sh "npm run test:e2e:electron"
      }
    }
  }

  post {
    always {
      archiveArtifacts artifacts: 'test/cypress/videos/**/*.*', fingerprint: true
      junit '${UNDERKATALOG_TESTRAPPORTER}/${TESTRAPPORTFILPATTERN}'
    }

    fixed {
      // Skicka epost om jobbet går bra igen
      emailext (
        subject: "Fixat! Jobb '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
        body: "Jobb '${env.JOB_NAME} [${env.BUILD_NUMBER}]' går nu BRA igen. Se konsollutmatning här: '${env.BUILD_URL}'",
        to: "johannes.larsson@nordicmedtest.se"
      )
    }

    failure {
      archiveArtifacts artifacts: 'test/cypress/screenshots/**/*.*', fingerprint: true
      archiveArtifacts artifacts: '.npm/_logs/*.log', fingerprint: true
    }

    // Denna sektion exekveras enbart om föregående körning gick bra och denna misslyckades
    regression {
      // Skicka epost om jobbet misslyckas
      emailext (
        subject: "Misslyckat! Jobb '${env.JOB_NAME} [${env.BUILD_NUMBER}]'",
        body: "Jobb '${env.JOB_NAME} [${env.BUILD_NUMBER}]' MISSLYCKADES! Se konsollutmatning här: '${env.BUILD_URL}'. Inga fler mail kommer skickas innan jobbet åter går bra.",
        to: "johannes.larsson@nordicmedtest.se"
      )
    }
  }
}
